- name: docker services
  hosts: all
  become: yes

  tasks:

  - docker_service:
      project_name: dokuwiki
      definition:
       version: '2'
       services:
        dokuwiki:
          image: mprasil/dokuwiki
          container_name: dokuwiki
          volumes:
            - "{{ dokuwiki['paths']['data'] }}:/dokuwiki/data"
            - "{{ dokuwiki['paths']['conf'] }}/conf:/dokuwiki/conf"
            - "{{ dokuwiki['paths']['plugins'] }}/lib/plugins:/dokuwiki/lib/plugins"
          ports:
            - "{{ services['dokuwiki']['web_port'] }}:80"

  - docker_service:
      project_name: tt-rss
      definition:
         version: '2'
         services:
          ttrss:
            image: clue/ttrss
            links:
            - "ttrss-postgres:db"
            ports:
            - "{{ services['ttrss']['web_port'] }}:80"
            container_name: ttrss
            environment:
            - "DB_PORT=5432"
            - "DB_TYPE=pgsql"
            - "DB_HOST=ttrss-postgres"
            - "SELF_URL_PATH=https://{{ services['ttrss']['domain'] }}/"

          ttrss-postgres:
            image: nornagon/postgres
            container_name: ttrss-postgres

  - docker_service:
      project_name: prosody
      definition:
        version: "2"
        service:
          prosody:
            image: prosody/prosody:0.10
            links:
            - "prosody-postgres"
            ports:
            - "5222:5222"  # c2s
            - "5269:5269"  # s2s
            - "5280:5280"  # BOSH
            - "5281:5281"  # Secure BOSH
            - "5347:5347"  # xmpp component
            - "services['prosody']['web_port']:80"  # HTTP

            volumes:
            - "{{ prosody['paths']['conf'] }}:/etc/prosody:ro"
            - "{{ prosody['paths']['lib'] }}:/var/lib/prosody"
            - "{{ prosody['paths']['log'] }}:/var/log/prosody"
            - "{{ prosody['paths']['modules'] }}:/usr/lib/prosody-modules"

            environment:
            - "LOCAL={{ prosody['admin_user'] }}"
            - "DOMAIN={{ prosody['admin_domain'] }}"
            - "PASSWORD={{ prosody['admin_password'] }}"

          prosody-postgres:
            image: nornagon/postgres
            container_name: prosody-postgres

